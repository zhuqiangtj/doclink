# DocLink - 智能预约管理系统

DocLink 是一个现代化的、基于 Web 的医疗预约和排班管理系统。它旨在为诊所和医疗机构提供一个高效、易用的平台，连接病人、医生和管理员，优化预约流程和资源管理。

## 核心功能

- **多角色认证系统**: 支持病人、医生、管理员三种不同角色的安全登录。
- **在线预约**: 病人可以方便地浏览医生排班、选择时间并在线预约。
- **医生工作台**: 医生可以管理自己的诊室、创建和调整未来的排班、查看和操作病人的预约，并能为病人代理预约。
- **管理员后台**: 管理员拥有最高权限，可以集中管理医生账户（增删改、重置密码）和系统其他核心资源。
- **密码管理**: 所有用户都可以安全地修改自己的登录密码。

## 本地化 (Localization)

- **界面语言**: 整个用户界面（UI）必须完全使用中文，不允许出现任何英文。

## 更新日志 (Changelog)

### 2025年10月29日 更新

本次更新是自项目启动以来最大规模的一次重构和功能增强，重点围绕医生工作台和病人预约流程，旨在提供更流畅、更直观的用户体验，并修复了多个关键 Bug。

#### 🌟 新功能与重构 (Features & Refactoring)

1.  **医生工作台 (Doctor Workbench) 全面重构**:
    *   **统一管理界面**: 废弃了旧的、基于模态对话框的排班管理方式，将排班创建/编辑、预约查看、取消/标记爽约、为病人预约等所有核心功能，全部整合到一个以日历为核心的、常驻的详情区域中。
    *   **日历联动**: 日历现在能根据医生排班的“可用名额”进行高亮显示，而非仅仅是“有排班记录”。
    *   **“使用模板填充”**: 医生可以快速选择诊室，一键为当天生成默认时间点排班模板，方便后续编辑。
    *   **原子化时间点管理**:
        *   每个时间点都可独立编辑诊室、时间、床位数。
        *   每个时间点都配有独立的“保存”和“删除”按钮，操作即时生效。
    *   **预约详情集成**: 在每个时间点下方，直接显示已预约病人的姓名。
    *   **预约操作集成**:
        *   为每个病人预约提供“取消预约”按钮。
        *   对于已过时的预约，提供“标记爽约”按钮。
    *   **为病人预约**: 在每个时间点旁边，新增“为病人预约”按钮，点击后弹出小型模态框，医生可搜索病人并快速为其预约。

2.  **病人首页 (Patient Home Page) 全新设计**:
    *   **医生选择**: 页面顶部新增医生选择下拉框，病人可选择医生。
    *   **日历联动**: 日历组件将显示所选医生有“可预约名额”的日期，并进行高亮。
    *   **时间点详情**: 点击日历上的日期后，下方会展示该医生当天所有时间点的列表，包括剩余床位。
    *   **预约操作**: 剩余床位大于0的时间点会显示“预约”按钮，点击后弹出确认模态框。
    *   **并发安全预约**: 后端预约 API (`POST /api/appointments`) 已重构，使用数据库事务确保多个病人同时预约同一时间点时的并发安全和数据一致性。
    *   **实时同步**: 预约成功后，页面数据自动刷新，更新剩余床位和预约状态。

#### 🐞 Bug 修复与稳定性提升 (Bug Fixes & Stability)

1.  **日期时区问题**: 彻底解决了日历高亮和日期显示因时区转换导致的“差一天”问题，确保前后端日期处理的绝对一致性。
2.  **API 健壮性**: 彻底重构了 `/api/schedules` 和 `/api/appointments` 等核心 API，修复了多个逻辑错误和 `any` 类型导致的 TypeScript 编译错误，提升了后端数据处理的准确性和并发安全性。
3.  **前端语法与逻辑**: 修复了 `app/doctor/schedule/page.tsx` 中因函数作用域、JSX 结构和 `useEffect` 依赖问题导致的多个 `ReferenceError` 和构建失败。
4.  **Git 工作流改进**: 明确了 `git add`, `git commit`, `git push` 的分步执行流程，以避免遗漏推送。

### 2025年10月24日 更新

本次更新包含了一次大规模的功能增强和 Bug 修复，重点提升了应用的健壮性、用户体验和交互的完整性。

#### 🌟 新功能 (Features)

1.  **信誉分与通知系统 (Credibility & Notification System)**
    - 为病人和医生分别建立了完整的通知系统，当预约被创建或取消时，相关方会收到应用内通知。
    - 在医生和病人的底部导航栏中增加了“通知”入口，并带有未读消息的红色数字角标。
    - 实现了完整的病人信誉分奖惩机制：
      - **取消预约**: 预约日前取消扣1分，当天取消扣5分。
      - **完成预约**: 医生确认病人签到后，病人信誉分+1。
      - **预约爽约**: 系统通过定时任务自动标记爽约，并扣除病人5分。

2.  **病人自助注册优化 (Patient Registration)**
    - 在登录页面增加了注册入口。
    - 实现了根据用户姓名自动生成 Pinyin 用户名的功能，并确保其唯一性。

3.  **医生视图增强 (Doctor View Enhancement)**
    - 医生现在可以在“我的排班”视图中直接看到每个时间点已预约病人的具体姓名，而不仅仅是数量。

#### 🎨 UI/UX 全面革新 (UI/UX Overhaul)

1.  **新设计语言**: 引入了新的色彩方案（活力蓝、警告橙、提示黄），全面替换了原有的朴素颜色。
2.  **移动端优化**: 显著增大了所有页面的基础字号、按钮尺寸和输入框高度，使其在手机上更易于阅读和操作。
3.  **交互反馈**: 为所有按钮和组件增加了更现代的悬停、点击动效和阴影效果，提升了操作的“呼吸感”。
4.  **布局优化**: 对所有核心页面（登录、注册、预约、设置、仪表板、用户管理等）进行了卡片化、模块化的重新布局，使信息结构更清晰、观感更现代化。

#### 🐞 Bug 修复与重构 (Bug Fixes & Refactoring)

1.  **核心逻辑修复**:
    - **删除用户**: 修复了因数据库外键约束导致无法删除用户的严重 Bug。
    - **管理员视图**: 修复了管理员仪表板数据不准确和用户管理标签页筛选错误的逻辑问题。
    - **状态更新**: 修复了管理员更新用户信息后，前端界面没有立即同步更新的问题。
2.  **认证与会话**: 修复了一个由服务端渲染（SSR）和会话状态不一致导致的严重 Bug，该 Bug 曾导致未登录用户能看到管理员界面。
3.  **代码质量**: 修复了多个在 `npm run build` 过程中发现的 TypeScript 类型错误、语法错误，并移除了大量无用的代码和变量。
4.  **审计日志**: 优化了审计日志的显示，现在优先展示操作员的真实姓名，而不是用户名。

---

## 角色与职责

系统围绕三个核心角色构建，每个角色都有明确的职责和权限。

### 1. 病人 (Patient)

病人是系统的主要使用者，专注于发现和预约服务。

- **账户**: 
  - **自助注册**: 新病人用户可在登录页面点击“注册”按钮进行自助注册。
  - **必填字段**: 注册时必须填写姓名、性别、出生日期、密码和确认密码。
  - **用户名自动生成**: 用户名将根据用户填写的中文姓名自动生成基于汉语拼音的用户名。系统会确保用户名的唯一性，如果存在重名，会自动添加后缀以避免冲突。
- **预约**: 
  - **医生选择**: 首页顶部提供医生选择下拉框。
  - **日历排班**: 日历高亮显示所选医生有可用名额的日期。
  - **时间点预约**: 点击日期后，下方显示时间点列表，可查看剩余床位，并点击“预约”按钮进行预约。
  - **并发安全**: 预约操作通过数据库事务确保并发安全。
- **管理**: 可以查看自己的预约历史，并取消未来的预约。
- **安全**: 可以修改自己的登录密码。

### 2. 医生 (Doctor)

医生是服务的提供者，专注于管理自己的工作安排和与病人的互动。

- **账户**: 医生的账户由**管理员**在后台创建，并设定初始密码。
- **诊室管理**: 登录后，可以在个人仪表板上**添加、修改或删除**自己名下的诊室，并设定每个诊室的床位数。
- **工作台 (核心)**:
  - **日历视图**: 以日历为核心，常驻显示排班详情。
  - **排班创建/编辑**: 可为任意日期创建排班，支持“使用模板填充”快速生成默认时间点。
  - **时间点精细管理**: 每个时间点可独立编辑诊室、时间、床位数，并即时保存。
  - **预约查看**: 直接显示每个时间点已预约病人的姓名。
  - **预约操作**: 提供“取消预约”、“标记爽约”和“为病人预约”按钮，操作即时生效。
- **安全**: 可以修改自己的登录密码。

### 3. 管理员 (Admin)

管理员是系统的维护者，拥有全局管理权限。

- **账户**: 系统包含一个默认的管理员账户 (用户名: `admin` / 密码: `admin123`)，通过数据库填充（seed）创建。
- **医生管理**: 
  - **增删改**: 可以在管理后台**创建、编辑和删除**医生信息。
  - **密码控制**: 创建医生时可**指定初始密码**，也可以随时**重置**任何一位医生用户的密码。
- **安全**: 可以修改自己的登录密码。

---

## 技术栈

- **框架**: [Next.js](https://nextjs.org/) (React)
- **后端 API**: Next.js API Routes
- **数据库**: PostgreSQL
- **ORM**: [Prisma](https://www.prisma.io/)
- **认证**: [Auth.js (NextAuth.js)](https://next-auth.js.org/)
- **UI**: [Tailwind CSS](https://tailwindcss.com/)
- **密码哈希**: [bcrypt](https://github.com/kelektiv/node.bcrypt.js)

## 如何开始

1.  **克隆仓库**:
    ```bash
    git clone <repository-url>
    cd doclink
    ```

2.  **安装依赖**:
    ```bash
    npm install
    ```

3.  **设置环境变量**:
    - 复制 `.env.example` 为 `.env`。
    - 在 `.env` 文件中填入您的数据库连接字符串 (`DATABASE_URL`)。

4.  **数据库迁移与填充**:
    - 首次运行时，应用迁移并填充管理员账户。
    ```bash
    npx prisma migrate dev
    npx prisma db seed
    ```

5.  **启动开发服务器**:
    ```bash
    npm run dev
    ```

现在，应用将在 `http://localhost:3000` 上运行。