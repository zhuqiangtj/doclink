## 2. 核心技术架构

本项目选用 **Next.js** 作为核心技术框架，构建现代化的 Web 应用。

- **前端**: **Next.js (React)**，配合 **Tailwind CSS** 或 **MUI** 等 UI 框架，实现移动优先的响应式设计。
- **后端**: **Next.js API Routes**，实现轻量级的后端服务，与前端代码库统一。
- **数据库**: **PostgreSQL**。配合 **Prisma** 作为 ORM，提供类型安全的数据访问层。
- **认证**: 基于 **JWT (JSON Web Tokens)** 的身份认证机制，支持手机验证码、微信网页授权等多种登录方式。

**选择理由**:
- **开发体验好**: Next.js 提供了一体化的前后端开发体验，上手快，效率高。
- **高性能**: 支持服务端渲染 (SSR) 和静态站点生成 (SSG)，应用加载速度快，用户体验好。
- **数据一致性**: PostgreSQL 作为关系型数据库，能更好地保证医疗预约场景下的数据完整性。
- **生态成熟**: 基于 React 和 Node.js 生态，拥有海量的库和社区支持。

**未来扩展性 (移植到微信小程序)**:
> 本项目采用 React 作为核心框架，为未来向多端扩展奠定了良好基础。若需移植到微信小程序，可利用 **Taro** 等跨端框架。届时，大部分业务逻辑和 UI 组件都可以被复用，从而极大降低迁移成本。

---

*The original text below has been removed to enhance readability and focus on the updated content.*
---
- **部署**: **Vercel** 或 Netlify，提供稳定、高效的持续集成与部署。

**选择理由**:
- **开发体验好**: Next.js 提供了一体化的前后端开发体验，上手快，效率高。
- **高性能**: 支持服务端渲染 (SSR) 和静态站点生成 (SSG)，应用加载速度快，用户体验好。
- **生态成熟**: 基于 React 生态，拥有海量的库和社区支持。
- **部署简单**: 与 Vercel 等平台无缝集成，实现自动化部署。

**未来扩展性 (移植到微信小程序)**:
> 本项目采用 React 作为核心框架，为未来向多端扩展奠定了良好基础。若需移植到微信小程序，可利用 **Taro** 等跨端框架。届时，大部分业务逻辑和 UI 组件都可以被复用，从而极大降低迁移成本。

## 3. 系统角色与职责

系统包含三类核心用户角色：

| 角色 | 使用平台 | 主要职责 |
| :--- | :--- | :--- |
| **患者** | **移动 Web 端** | 浏览医生信息、预约床位、管理个人预约、**到院后在线签到、实时查看排队进度**。 |
| **医生** | Web 管理后台 | 登录个人账号，管理个人排班、**管理今日就诊队列、呼叫患者就诊、标记治疗结束**。 |
| **管理员** | Web 管理后台 | 拥有最高权限，管理诊室、床位、医生信息和所有预约记录。 |

## 4. 功能模块详述

### 4.1. 患者端 (移动 Web)

- **用户模块**:
  - `手机验证码登录/注册` & `微信网页授权登录` & `个人信息管理` & `就诊人管理`。

- **浏览与查询模块**:
  - `首页`: 诊所品牌展示、医生列表入口。
  - `医生列表`: 统一展示所有针灸科医生。
  - `医生主页`: 展示医生信息及其 **出诊时间表**。

- **核心预约模块**:
  - `号源查看`: 清晰展示未来可预约的时间点及 **剩余床位数**。
  - `预约规则`: 患者可预约自当前时间起 **3天内** 的治疗，每次治疗时长 **45分钟**。
  - `预约流程`: 选择就诊人、填写病情描述、提交预约。
  - `消息通知`: 通过 **短信服务** 或 **Web Push**，发送预约成功、就诊提醒、取消成功等通知。

- **就诊日流程模块**:
  - `到院签到`: 在“我的预约”中，为“待就诊”的预约提供“签到”按钮。
  - `排队状态`: 签到成功后，进入排队队列，页面实时显示排队信息。
  - `到号提醒`: 轮到就诊时，系统通过 **短信** 或 **Web Push** 发送强提醒。

- **个人中心 ("我的")**:
  - `我的预约`: 分类展示所有状态的预约列表。
  - `取消预约`: 提供便捷的自助取消入口。
  - `我的信用分`: 展示用户当前的信用分和历史记录。

### 4.2. 管理端 (Web 后台)

- **管理员视图**:
  - `仪表盘 (Dashboard)`: 核心数据统计。
  - `诊室管理 (核心)`: 用于增、删、改、查诊室信息。可以为每个诊室设定一个 **可修改的默认床位数** (例如: 4张)，这个数字将作为医生排班时的初始带入值。
  - `医生管理`: 维护医生信息，并为每位医生 **关联一个或多个诊室**。
  - `预约总览`: 查看和管理全诊所的预约记录。

- **医生视图**:
  - `我的排班日历`: 以日历形式直观展示个人未来的出诊安排。
  - `排班与床位管理 (核心功能)`:
    - **排班流程**: 医生选择一个**日期** -> 选择一个名下的**诊室** -> 系统会根据管理员设定的默认班次（如08:00, 09:00等）和该诊室的默认床位数，**预创建**当天的排班框架。
    - **灵活调整**: 医生可以基于这个框架，自由**修改、删除或增加**任何时间点的班次，并能**独立调整**每个时间点可预约的**具体床位数**。
    - **核心逻辑**: 只有经过医生确认并发布的排班，才会最终成为患者可预约的号源。如果医生某天不排班，则当天无任何号源。
  - `今日接诊列表`: 升级为动态就诊队列，分为“待签到”和“已签到”两个区域。
  - `叫号与治疗管理`: 医生可对“已签到”队列的患者进行“呼叫就诊”和“结束治疗”的操作。

## 5. 履约激励与约束机制

为减少爽约率，提升运营效率，系统将引入一套全新的信用分体系。

- **预防机制**:
  - `自动提醒`: 在预约前24小时和前2小时，通过短信等方式自动发送提醒。
  - `便捷取消`: 提供清晰的自助取消渠道，并明确告知不同时间取消的后果。

- **信用分体系 (核心变更)**:
  - `初始分数`: 新用户注册后，默认拥有 **15分** 信用分。
  - `分数规则`:
    - **按时就诊**: `+1分`。
    - **提前取消**: 在预约日期 **前一天（自然日）或更早** 取消，` -1分`。
    - **当天取消**: 在预约 **当天（自然日）** 取消，视为爽约，`-5分`。
    - **未签到爽约**: 超过预约时间仍未签到，由系统自动标记为爽约，`-5分`。
  - `权限体系`:
    - **正常预约 (1-15分)**: 用户可正常使用预约功能。
    - **资格暂停 (0分)**: 当用户信用分 **扣减至0分时**，系统将 **自动暂停其预约资格**。
  - `分数重置`:
    - 资格暂停后，患者无法自行恢复。必须联系 **医生或管理员**，由其在后台 **手动为患者重置分数** (例如，重置回15分)，方可重新获得预约权限。

## 6. 云数据库设计与关系梳理

数据关系的核心是：`管理员`定义物理资源 (`rooms`) -> `医生`基于物理资源创建可售卖的时间资源 (`schedules`) -> `患者`购买时间资源，生成最终的 `appointments` 记录。

1.  **`rooms` (诊室信息)**
    - **作用**: 定义物理空间及其基础资源。
    - `_id`: String (主键)
    - `name`: String (诊室名称)
    - `bedCount`: Number (**默认床位数**, 可由管理员修改)

2.  **`doctors` (医生信息)**
    - **作用**: 定义核心服务提供者及其可使用的资源范围。
    - `name`: String (姓名)
    - `accountId`: String (登录ID)
    - `roomIds`: Array<String> (**核心关联**: 指明该医生有权在哪些诊室 (`rooms`) 中排班)

3.  **`schedules` (医生排班)**
    - **作用**: 定义“号源”，即医生在特定时间、特定地点提供的可预约服务。
    - `_id`: String (主键)
    - `doctorId`: String (关联到 `doctors`)
    - `date`: String (出诊日期)
    - `timeSlots`: Array
      - `time`: String (时间点, "09:00")
      - `roomId`: String (本次服务所在的诊室, 关联到 `rooms`)
      - `total`: Number (**核心**: 该时间点可预约的总床位数。创建时默认为 `rooms.bedCount`，但可由医生独立修改)
      - `booked`: Number (已预约数)

4.  **`appointments` (预约记录) - 状态变更**
    - **作用**: 记录一次成功的预约，连接了“谁”在“什么时间”预约了“哪位医生”的“哪个诊室”的“哪个床位”。
    - `_id`: String (主键)
    - `userId`: String (关联到 `users`, 替代 `_openid`)
    - `patientId`: String (关联到 `patients`, 即就诊人)
    - `doctorId`: String (关联到 `doctors`)
    - `scheduleId`: String (关联到 `schedules`)
    - `time`: String (冗余时间点 "09:00")
    - `roomId`: String (冗余诊室ID)
    - `bedId`: Number (本次预约分配到的具体床位号)
    - `status`: String (预约状态: `pending`待就诊, `checkedIn`已签到, `inProgress`就诊中, `completed`已完成, **`cancelled_early`提前取消**, **`cancelled_late`当天取消**, `noShow`爽约)
    - `createTime`: Date (创建时间)

5.  **`users` (用户信息) - 结构变更**
    - `_id`: String (主键)
    - `phone`: String (手机号)
    - `credibilityScore`: Number (**信用分**, 默认15)
    - `isSuspended`: Boolean (**新增**: 资格是否被暂停, 默认 `false`)

6.  **`patients` (就诊人信息)**
    - 基础信息表，无核心关系变更。

## 7. 开发路线图

1.  **阶段一：环境搭建与基础功能 (1周)**
    - 创建小程序项目，开通云开发。
    - **后台**: 开发诊室管理、医生管理（含指派诊室）功能。
    - **小程序**: 开发医生列表、医生主页，实现数据读取与展示。

2.  **阶段二：核心预约流程 (1.5周)**
    - **后台**: 开发排班管理功能（含自动计算号源）。
    - **小程序**: 开发用户登录、就诊人管理、号源查看、创建/取消预约的完整流程。
    - **云函数**: 编写创建预约和取消预约的核心云函数。

3.  **阶段三：信用分与自动化机制 (1.5周)**
    - **小程序**: 开发个人中心、我的信用分页面。
    - **云函数**: 编写 **定时云函数**，用于自动扫描并标记爽约订单，并更新用户信用分。
    - **消息通知**: 配置并测试预约提醒、状态变更等服务通知。

4.  **阶段四：线下签到与排队系统 (1.5周) - 新增**
    - **小程序**: 开发“待就诊”预约的签到功能和排队状态的实时显示。
    - **后台**: 升级医生视图为动态就诊队列，增加“呼叫就诊”和“结束治疗”的操作功能。
    - **云函数**: 编写处理签到、排队、叫号逻辑的核心云函数。

5.  **阶段五：Web 管理后台完善 (1周)**
    - 完善管理员的预约总览和数据看板。
    - 完善医生视图的历史接诊记录查询。

6.  **阶段六：联调测试与上线 (1周)**
    - 进行完整的功能与流程测试，修复Bug。
    - 提交小程序审核并发布。
---
<br>

## 7. 部署方案 (面向中国大陆)

### 7.1. 核心挑战

1.  **网络性能与稳定性**: 直接使用 Cloudflare Pages 等境外服务，中国大陆用户访问时会因 GFW 导致速度缓慢且不稳定。
2.  **法律合规性**: 在中国大陆运营网站必须申请 **ICP 备案**，而这要求使用境内的云服务商。

### 7.2. 推荐方案

- **应用托管**: 使用 **阿里云** 或 **腾讯云** 的 Serverless 产品 (如函数计算) 或轻量应用服务器来部署 Next.js 应用。
- **数据库**: 使用相应云服务商的 **云数据库 PostgreSQL 版** (如 RDS for PostgreSQL)。确保数据库与应用服务器在同一地域以获得最佳性能。
- **域名与备案**: 注册域名并在对应的云服务商平台完成 **ICP 备案**。
- **CDN 加速**: 使用国内云服务商的 CDN 服务对网站静态资源进行分发加速。

---

## 8. 开发路线图 (已更新)

1.  **阶段一：技术选型与原型设计 (0.5周)**
    - 初始化 Next.js 项目，集成 Prisma 与 PostgreSQL。
    - 设计核心页面 (医生列表、预约日历) 的 UI/UX 原型。

2.  **阶段二：基础后台与数据结构 (1.5周)**
    - **后台**: 开发诊室管理、医生管理（含关联诊室）的 API 和后台界面。
    - **数据库**: 使用 Prisma 构建所有核心数据表的 schema。

3.  **阶段三：核心预约流程 (1.5周)**
    - **后台**: 开发医生排班管理（创建、调整号源）的 API 和后台界面。
    - **前端**: 开发用户认证、医生主页号源查看、创建/取消预约的完整流程。

4.  **阶段四：信用分与自动化机制 (1周)**
    - **后端**: 实现信用分加减、账户暂停与重置的 API 逻辑。
    - **定时任务**: 创建一个定时任务 (Cron Job)，用于自动扫描并标记爽约订单，并更新用户信用分。

5.  **阶段五：线下签到与排队系统 (1.5周)**
    - **前端**: 开发“待就诊”预约的签到功能和排队状态的实时显示。
    - **后台**: 升级医生视图为动态就诊队列，增加“呼叫就诊”和“结束治疗”的 API 和操作功能。

6.  **阶段六：部署与测试 (1周)**
    - 在选定的国内云平台（如阿里云）上配置生产环境。
    - 进行完整的功能与流程测试，修复 Bug。
    - 提交 ICP 备案申请。